<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Nginx | Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Nginx之前其他服务器Apache、Lighttpd、Tomcat、Jetty、IIS，它们都是Web服务器，或者叫做WWW（World Wide Web）服务器，相应地也都具备Web服务器的基本功能：基于REST架构风格[插图]，以统一资源描述符（Uniform ResourceIdentifier，URI）或者统一资源定位符（Uniform Resource Locator，URL）作为沟通">
<meta property="og:type" content="article">
<meta property="og:title" content="Nginx">
<meta property="og:url" content="http://127.0.0.1:4000/2021/10/12/Nginx/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="Nginx之前其他服务器Apache、Lighttpd、Tomcat、Jetty、IIS，它们都是Web服务器，或者叫做WWW（World Wide Web）服务器，相应地也都具备Web服务器的基本功能：基于REST架构风格[插图]，以统一资源描述符（Uniform ResourceIdentifier，URI）或者统一资源定位符（Uniform Resource Locator，URL）作为沟通">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="c:/Users/track/AppData/Roaming/Typora/typora-user-images/image-20210913102343939.png">
<meta property="article:published_time" content="2021-10-12T03:20:59.800Z">
<meta property="article:modified_time" content="2021-10-12T03:20:59.800Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="c:/Users/track/AppData/Roaming/Typora/typora-user-images/image-20210913102343939.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://127.0.0.1:4000"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Nginx" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2021/10/12/Nginx/" class="article-date">
  <time datetime="2021-10-12T03:20:59.800Z" itemprop="datePublished">2021-10-12</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Nginx
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="Nginx之前"><a href="#Nginx之前" class="headerlink" title="Nginx之前"></a>Nginx之前</h2><h3 id="其他服务器"><a href="#其他服务器" class="headerlink" title="其他服务器"></a>其他服务器</h3><p>Apache、Lighttpd、Tomcat、Jetty、IIS，它们都是Web服务器，或者叫做WWW（World Wide Web）服务器，相应地也都具备Web服务器的基本功能：基于REST架构风格[插图]，以统一资源描述符（Uniform ResourceIdentifier，URI）或者统一资源定位符（Uniform Resource Locator，URL）作为沟通依据，通过HTTP为浏览器等客户端程序提供各种网络服务。</p>
<p>Tomcat和Jetty面向Java语言，先天就是重量级的Web服务器，它的性能与Nginx没有可比性。</p>
<p>IIS只能在Windows操作系统上运行。Windows作为服务器在稳定性与其他一些性能上都不如类UNIX操作系统，因此，在需要高性能Web服务器的场合下，IIS可能会被“冷落”。</p>
<p>Apache的发展时期很长，而且是目前毫无争议的世界第一大Web服务器。</p>
<p>Lighttpd和Nginx一样，都是轻量级、高性能的Web服务器，欧美的业界开发者比较钟爱Lighttpd，而国内的公司更青睐Nginx，Lighttpd使用得比较少。</p>
<h3 id="nginx优点"><a href="#nginx优点" class="headerlink" title="nginx优点"></a>nginx优点</h3><p>Nginx是一个跨平台的Web服务器，可运行在Linux、FreeBSD、Solaris、AIX、Mac OS、Windows等操作系统上，并且它还可以使用当前操作系统特有的一些高效API来提高自己的性能。</p>
<p>对于高效处理大规模并发连接，它支持Linux上的epoll、Solaris上的event ports和FreeBSD上的kqueue等。</p>
<p>Nginx支持其独有的sendfile系统调用，这个系统调用可以高效地把硬盘中的数据发送到网络上（不需要先把硬盘数据复制到用户态内存上再发送），这极大地减少了内核态与用户态数据间的复制动作。（零拷贝）</p>
<p>总结一下nginx的优点：</p>
<ul>
<li>更快</li>
<li>高扩展性</li>
<li>高可靠性</li>
<li>低内存消耗</li>
</ul>
<h3 id="Nginx安装"><a href="#Nginx安装" class="headerlink" title="Nginx安装"></a>Nginx安装</h3><p>需要的软件</p>
<p><strong>GCC</strong></p>
<p>GCC（GNU Compiler Collection）可用来编译C语言程序。</p>
<p><strong>PCRE库</strong></p>
<p>PCRE（Perl Compatible Regular Expressions，Perl兼容正则表达式）是由Philip Hazel开发的函数库，目前为很多软件所使用，该库支持正则表达式。它由RegEx演化而来，实际上，Perl正则表达式也是源自于Henry Spencer写的RegEx。</p>
<p>如果我们在配置文件nginx.conf里使用了正则表达式，那么在编译Nginx时就必须把PCRE库编译进Nginx，因为Nginx的HTTP模块要靠它来解析正则表达式。</p>
<p>pcre-devel是使用PCRE做二次开发时所需要的开发库，包括头文件等，这也是编译Nginx所必须使用的。</p>
<p><strong>zlib库</strong></p>
<p>zlib库用于对HTTP包的内容做gzip格式的压缩，如果我们在nginx.conf里配置了gzip on，并指定对于某些类型（content-type）的HTTP响应使用gzip来进行压缩以减少网络传输量，那么，在编译时就必须把zlib编译进Nginx。</p>
<p><strong>OpenSSL开发库</strong></p>
<p>如果我们的服务器不只是要支持HTTP，还需要在更安全的SSL协议上传输HTTP，那么就需要拥有OpenSSL了。另外，如果我们想使用MD5、SHA1等散列函数，那么也需要安装它。</p>
<p>Nginx是高度自由化的Web服务器，它的功能是由许多模块来支持的。而这些模块可根据我们的使用需求来定制，如果某些模块不需要使用则完全不必理会它。同样，如果使用了某个模块，而这个模块使用了一些类似zlib或OpenSSL等的第三方库，那么就必须先安装这些软件。</p>
<h2 id="反向代理"><a href="#反向代理" class="headerlink" title="反向代理"></a>反向代理</h2><h3 id="正向代理"><a href="#正向代理" class="headerlink" title="正向代理"></a>正向代理</h3><p>正向代理，意思是一个位于客户端和原始服务器(origin server)之间的服务器，为了从原始服务器取得内容，客户端向代理发送一个请求并指定目标(原始服务器)，然后代理向原始服务器转交请求并将获得的内容返回给客户端。客户端才能使用正向代理</p>
<p>用户知道访问的是什么服务，但是服务不清楚真正的访问者。比如国内用户使用vpn翻墙去访问国外网站。</p>
<img src="C:\Users\track\AppData\Roaming\Typora\typora-user-images\image-20210913102343939.png" alt="image-20210913102343939" style="zoom:50%;" />





<h3 id="反向代理-1"><a href="#反向代理-1" class="headerlink" title="反向代理"></a>反向代理</h3><h2 id="Nginx命令"><a href="#Nginx命令" class="headerlink" title="Nginx命令"></a>Nginx命令</h2><h3 id="configure详解"><a href="#configure详解" class="headerlink" title="configure详解"></a>configure详解</h3><p>命令再nginx安装文件位置下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line">[root@iZ2ze30bctfwzlavplz52aZ nginx-1.20.1]<span class="comment"># ./configure --help </span></span><br><span class="line"></span><br><span class="line">  --<span class="built_in">help</span>                             <span class="built_in">print</span> this message</span><br><span class="line"></span><br><span class="line">  --prefix=PATH                      <span class="built_in">set</span> installation prefix</span><br><span class="line">  --sbin-path=PATH                   <span class="built_in">set</span> nginx binary pathname</span><br><span class="line">  --modules-path=PATH                <span class="built_in">set</span> modules path</span><br><span class="line">  --conf-path=PATH                   <span class="built_in">set</span> nginx.conf pathname</span><br><span class="line">  --error-log-path=PATH              <span class="built_in">set</span> error <span class="built_in">log</span> pathname</span><br><span class="line">  --pid-path=PATH                    <span class="built_in">set</span> nginx.pid pathname</span><br><span class="line">  --lock-path=PATH                   <span class="built_in">set</span> nginx.lock pathname</span><br><span class="line"></span><br><span class="line">  --user=USER                        <span class="built_in">set</span> non-privileged user <span class="keyword">for</span></span><br><span class="line">                                     worker processes</span><br><span class="line">  --group=GROUP                      <span class="built_in">set</span> non-privileged group <span class="keyword">for</span></span><br><span class="line">                                     worker processes</span><br><span class="line"></span><br><span class="line">  --build=NAME                       <span class="built_in">set</span> build name</span><br><span class="line">  --builddir=DIR                     <span class="built_in">set</span> build directory</span><br><span class="line"></span><br><span class="line">  --with-select_module               <span class="built_in">enable</span> select module</span><br><span class="line">  --without-select_module            <span class="built_in">disable</span> select module</span><br><span class="line">  --with-poll_module                 <span class="built_in">enable</span> poll module</span><br><span class="line">  --without-poll_module              <span class="built_in">disable</span> poll module</span><br><span class="line"></span><br><span class="line">  --with-threads                     <span class="built_in">enable</span> thread pool support</span><br><span class="line"></span><br><span class="line">  --with-file-aio                    <span class="built_in">enable</span> file AIO support</span><br><span class="line"></span><br><span class="line">  --with-http_ssl_module             <span class="built_in">enable</span> ngx_http_ssl_module</span><br><span class="line">  --with-http_v2_module              <span class="built_in">enable</span> ngx_http_v2_module</span><br><span class="line">  --with-http_realip_module          <span class="built_in">enable</span> ngx_http_realip_module</span><br><span class="line">  --with-http_addition_module        <span class="built_in">enable</span> ngx_http_addition_module</span><br><span class="line">  --with-http_xslt_module            <span class="built_in">enable</span> ngx_http_xslt_module</span><br><span class="line">  --with-http_xslt_module=dynamic    <span class="built_in">enable</span> dynamic ngx_http_xslt_module</span><br><span class="line">  --with-http_image_filter_module    <span class="built_in">enable</span> ngx_http_image_filter_module</span><br><span class="line">  --with-http_image_filter_module=dynamic</span><br><span class="line">                                     <span class="built_in">enable</span> dynamic ngx_http_image_filter_module</span><br><span class="line">  --with-http_geoip_module           <span class="built_in">enable</span> ngx_http_geoip_module</span><br><span class="line">  --with-http_geoip_module=dynamic   <span class="built_in">enable</span> dynamic ngx_http_geoip_module</span><br><span class="line">  --with-http_sub_module             <span class="built_in">enable</span> ngx_http_sub_module</span><br><span class="line">  --with-http_dav_module             <span class="built_in">enable</span> ngx_http_dav_module</span><br><span class="line">  --with-http_flv_module             <span class="built_in">enable</span> ngx_http_flv_module</span><br><span class="line">  --with-http_mp4_module             <span class="built_in">enable</span> ngx_http_mp4_module</span><br><span class="line">  --with-http_gunzip_module          <span class="built_in">enable</span> ngx_http_gunzip_module</span><br><span class="line">  --with-http_gzip_static_module     <span class="built_in">enable</span> ngx_http_gzip_static_module</span><br><span class="line">  --with-http_auth_request_module    <span class="built_in">enable</span> ngx_http_auth_request_module</span><br><span class="line">  --with-http_random_index_module    <span class="built_in">enable</span> ngx_http_random_index_module</span><br><span class="line">  --with-http_secure_link_module     <span class="built_in">enable</span> ngx_http_secure_link_module</span><br><span class="line">  --with-http_degradation_module     <span class="built_in">enable</span> ngx_http_degradation_module</span><br><span class="line">  --with-http_slice_module           <span class="built_in">enable</span> ngx_http_slice_module</span><br><span class="line">  --with-http_stub_status_module     <span class="built_in">enable</span> ngx_http_stub_status_module</span><br><span class="line"></span><br><span class="line">  --without-http_charset_module      <span class="built_in">disable</span> ngx_http_charset_module</span><br><span class="line">  --without-http_gzip_module         <span class="built_in">disable</span> ngx_http_gzip_module</span><br><span class="line">  --without-http_ssi_module          <span class="built_in">disable</span> ngx_http_ssi_module</span><br><span class="line">  --without-http_userid_module       <span class="built_in">disable</span> ngx_http_userid_module</span><br><span class="line">  --without-http_access_module       <span class="built_in">disable</span> ngx_http_access_module</span><br><span class="line">  --without-http_auth_basic_module   <span class="built_in">disable</span> ngx_http_auth_basic_module</span><br><span class="line">  --without-http_mirror_module       <span class="built_in">disable</span> ngx_http_mirror_module</span><br><span class="line">  --without-http_autoindex_module    <span class="built_in">disable</span> ngx_http_autoindex_module</span><br><span class="line">  --without-http_geo_module          <span class="built_in">disable</span> ngx_http_geo_module</span><br><span class="line">  --without-http_map_module          <span class="built_in">disable</span> ngx_http_map_module</span><br><span class="line">  --without-http_split_clients_module <span class="built_in">disable</span> ngx_http_split_clients_module</span><br><span class="line">  --without-http_referer_module      <span class="built_in">disable</span> ngx_http_referer_module</span><br><span class="line">  --without-http_rewrite_module      <span class="built_in">disable</span> ngx_http_rewrite_module</span><br><span class="line">  --without-http_proxy_module        <span class="built_in">disable</span> ngx_http_proxy_module</span><br><span class="line">  --without-http_fastcgi_module      <span class="built_in">disable</span> ngx_http_fastcgi_module</span><br><span class="line">  --without-http_uwsgi_module        <span class="built_in">disable</span> ngx_http_uwsgi_module</span><br><span class="line">  --without-http_scgi_module         <span class="built_in">disable</span> ngx_http_scgi_module</span><br><span class="line">  --without-http_grpc_module         <span class="built_in">disable</span> ngx_http_grpc_module</span><br><span class="line">  --without-http_memcached_module    <span class="built_in">disable</span> ngx_http_memcached_module</span><br><span class="line">  --without-http_limit_conn_module   <span class="built_in">disable</span> ngx_http_limit_conn_module</span><br><span class="line">  --without-http_limit_req_module    <span class="built_in">disable</span> ngx_http_limit_req_module</span><br><span class="line">  --without-http_empty_gif_module    <span class="built_in">disable</span> ngx_http_empty_gif_module</span><br><span class="line">  --without-http_browser_module      <span class="built_in">disable</span> ngx_http_browser_module</span><br><span class="line">  --without-http_upstream_hash_module</span><br><span class="line">                                     <span class="built_in">disable</span> ngx_http_upstream_hash_module</span><br><span class="line">  --without-http_upstream_ip_hash_module</span><br><span class="line">                                     <span class="built_in">disable</span> ngx_http_upstream_ip_hash_module</span><br><span class="line">  --without-http_upstream_least_conn_module</span><br><span class="line">                                     <span class="built_in">disable</span> ngx_http_upstream_least_conn_module</span><br><span class="line">  --without-http_upstream_random_module</span><br><span class="line">                                     <span class="built_in">disable</span> ngx_http_upstream_random_module</span><br><span class="line">  --without-http_upstream_keepalive_module</span><br><span class="line">                                     <span class="built_in">disable</span> ngx_http_upstream_keepalive_module</span><br><span class="line">  --without-http_upstream_zone_module</span><br><span class="line">                                     <span class="built_in">disable</span> ngx_http_upstream_zone_module</span><br><span class="line"></span><br><span class="line">  --with-http_perl_module            <span class="built_in">enable</span> ngx_http_perl_module</span><br><span class="line">  --with-http_perl_module=dynamic    <span class="built_in">enable</span> dynamic ngx_http_perl_module</span><br><span class="line">  --with-perl_modules_path=PATH      <span class="built_in">set</span> Perl modules path</span><br><span class="line">  --with-perl=PATH                   <span class="built_in">set</span> perl binary pathname</span><br><span class="line"></span><br><span class="line">  --http-log-path=PATH               <span class="built_in">set</span> http access <span class="built_in">log</span> pathname</span><br><span class="line">  --http-client-body-temp-path=PATH  <span class="built_in">set</span> path to store</span><br><span class="line">                                     http client request body temporary files</span><br><span class="line">  --http-proxy-temp-path=PATH        <span class="built_in">set</span> path to store</span><br><span class="line">                                     http proxy temporary files</span><br><span class="line">  --http-fastcgi-temp-path=PATH      <span class="built_in">set</span> path to store</span><br><span class="line">                                     http fastcgi temporary files</span><br><span class="line">  --http-uwsgi-temp-path=PATH        <span class="built_in">set</span> path to store</span><br><span class="line">                                     http uwsgi temporary files</span><br><span class="line">  --http-scgi-temp-path=PATH         <span class="built_in">set</span> path to store</span><br><span class="line">                                     http scgi temporary files</span><br><span class="line"></span><br><span class="line">  --without-http                     <span class="built_in">disable</span> HTTP server</span><br><span class="line">  --without-http-cache               <span class="built_in">disable</span> HTTP cache</span><br><span class="line"></span><br><span class="line">  --with-mail                        <span class="built_in">enable</span> POP3/IMAP4/SMTP proxy module</span><br><span class="line">  --with-mail=dynamic                <span class="built_in">enable</span> dynamic POP3/IMAP4/SMTP proxy module</span><br><span class="line">  --with-mail_ssl_module             <span class="built_in">enable</span> ngx_mail_ssl_module</span><br><span class="line">  --without-mail_pop3_module         <span class="built_in">disable</span> ngx_mail_pop3_module</span><br><span class="line">  --without-mail_imap_module         <span class="built_in">disable</span> ngx_mail_imap_module</span><br><span class="line">  --without-mail_smtp_module         <span class="built_in">disable</span> ngx_mail_smtp_module</span><br><span class="line"></span><br><span class="line">  --with-stream                      <span class="built_in">enable</span> TCP/UDP proxy module</span><br><span class="line">  --with-stream=dynamic              <span class="built_in">enable</span> dynamic TCP/UDP proxy module</span><br><span class="line">  --with-stream_ssl_module           <span class="built_in">enable</span> ngx_stream_ssl_module</span><br><span class="line">  --with-stream_realip_module        <span class="built_in">enable</span> ngx_stream_realip_module</span><br><span class="line">  --with-stream_geoip_module         <span class="built_in">enable</span> ngx_stream_geoip_module</span><br><span class="line">  --with-stream_geoip_module=dynamic <span class="built_in">enable</span> dynamic ngx_stream_geoip_module</span><br><span class="line">  --with-stream_ssl_preread_module   <span class="built_in">enable</span> ngx_stream_ssl_preread_module</span><br><span class="line">  --without-stream_limit_conn_module <span class="built_in">disable</span> ngx_stream_limit_conn_module</span><br><span class="line">  --without-stream_access_module     <span class="built_in">disable</span> ngx_stream_access_module</span><br><span class="line">  --without-stream_geo_module        <span class="built_in">disable</span> ngx_stream_geo_module</span><br><span class="line">  --without-stream_map_module        <span class="built_in">disable</span> ngx_stream_map_module</span><br><span class="line">  --without-stream_split_clients_module</span><br><span class="line">                                     <span class="built_in">disable</span> ngx_stream_split_clients_module</span><br><span class="line">  --without-stream_return_module     <span class="built_in">disable</span> ngx_stream_return_module</span><br><span class="line">  --without-stream_set_module        <span class="built_in">disable</span> ngx_stream_set_module</span><br><span class="line">  --without-stream_upstream_hash_module</span><br><span class="line">                                     <span class="built_in">disable</span> ngx_stream_upstream_hash_module</span><br><span class="line">  --without-stream_upstream_least_conn_module</span><br><span class="line">                                     <span class="built_in">disable</span> ngx_stream_upstream_least_conn_module</span><br><span class="line">  --without-stream_upstream_random_module</span><br><span class="line">                                     <span class="built_in">disable</span> ngx_stream_upstream_random_module</span><br><span class="line">  --without-stream_upstream_zone_module</span><br><span class="line">                                     <span class="built_in">disable</span> ngx_stream_upstream_zone_module</span><br><span class="line"></span><br><span class="line">  --with-google_perftools_module     <span class="built_in">enable</span> ngx_google_perftools_module</span><br><span class="line">  --with-cpp_test_module             <span class="built_in">enable</span> ngx_cpp_test_module</span><br><span class="line"></span><br><span class="line">  --add-module=PATH                  <span class="built_in">enable</span> external module</span><br><span class="line">  --add-dynamic-module=PATH          <span class="built_in">enable</span> dynamic external module</span><br><span class="line"></span><br><span class="line">  --with-compat                      dynamic modules compatibility</span><br><span class="line"></span><br><span class="line">  --with-cc=PATH                     <span class="built_in">set</span> C compiler pathname</span><br><span class="line">  --with-cpp=PATH                    <span class="built_in">set</span> C preprocessor pathname</span><br><span class="line">  --with-cc-opt=OPTIONS              <span class="built_in">set</span> additional C compiler options</span><br><span class="line">  --with-ld-opt=OPTIONS              <span class="built_in">set</span> additional linker options</span><br><span class="line">  --with-cpu-opt=CPU                 build <span class="keyword">for</span> the specified CPU, valid values:</span><br><span class="line">                                     pentium, pentiumpro, pentium3, pentium4,</span><br><span class="line">                                     athlon, opteron, sparc32, sparc64, ppc64</span><br><span class="line"></span><br><span class="line">  --without-pcre                     <span class="built_in">disable</span> PCRE library usage</span><br><span class="line">  --with-pcre                        force PCRE library usage</span><br><span class="line">  --with-pcre=DIR                    <span class="built_in">set</span> path to PCRE library sources</span><br><span class="line">  --with-pcre-opt=OPTIONS            <span class="built_in">set</span> additional build options <span class="keyword">for</span> PCRE</span><br><span class="line">  --with-pcre-jit                    build PCRE with JIT compilation support</span><br><span class="line"></span><br><span class="line">  --with-zlib=DIR                    <span class="built_in">set</span> path to zlib library sources</span><br><span class="line">  --with-zlib-opt=OPTIONS            <span class="built_in">set</span> additional build options <span class="keyword">for</span> zlib</span><br><span class="line">  --with-zlib-asm=CPU                use zlib assembler sources optimized</span><br><span class="line">                                     <span class="keyword">for</span> the specified CPU, valid values:</span><br><span class="line">                                     pentium, pentiumpro</span><br><span class="line"></span><br><span class="line">  --with-libatomic                   force libatomic_ops library usage</span><br><span class="line">  --with-libatomic=DIR               <span class="built_in">set</span> path to libatomic_ops library sources</span><br><span class="line"></span><br><span class="line">  --with-openssl=DIR                 <span class="built_in">set</span> path to OpenSSL library sources</span><br><span class="line">  --with-openssl-opt=OPTIONS         <span class="built_in">set</span> additional build options <span class="keyword">for</span> OpenSSL</span><br><span class="line"></span><br><span class="line">  --with-debug                       <span class="built_in">enable</span> debug logging</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="nginx"><a href="#nginx" class="headerlink" title="./nginx"></a>./nginx</h3><p><strong>启动</strong></p>
<p>在nginx安装目录的sbin文件夹下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nginx</span><br></pre></td></tr></table></figure>



<p><strong>关闭</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nginx -s stop</span><br></pre></td></tr></table></figure>



<p><strong>优雅关闭</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nginx -s quit</span><br></pre></td></tr></table></figure>



<p><strong>重新载入配置</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nginx -s reload</span><br></pre></td></tr></table></figure>



<p><strong>日志文件回滚</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./nginx -s reopen</span><br></pre></td></tr></table></figure>







<h2 id="Nginx配置"><a href="#Nginx配置" class="headerlink" title="Nginx配置"></a>Nginx配置</h2><h3 id="nginx配置结构"><a href="#nginx配置结构" class="headerlink" title="nginx配置结构"></a>nginx配置结构</h3><p><strong>块配置项</strong></p>
<p>块配置项由一个块配置项名和一对大括号组成。    nginx的配置结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">...              #全局块</span><br><span class="line"></span><br><span class="line">events &#123;         #events块</span><br><span class="line">   ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http      #http块</span><br><span class="line">&#123;</span><br><span class="line">    ...   #http全局块</span><br><span class="line">    server        #server块</span><br><span class="line">    &#123; </span><br><span class="line">        ...       #server全局块</span><br><span class="line">        location [PATTERN]   #location块</span><br><span class="line">        &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">        location [PATTERN] </span><br><span class="line">        &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    server</span><br><span class="line">    &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    ...     #http全局块</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>全局块</strong>：配置影响nginx全局的指令。一般有运行nginx服务器的用户组，nginx进程pid存放路径，日志存放路径，配置文件引入，允许生成worker process数等。</li>
<li><strong>events块</strong>：配置影响nginx服务器或与用户的网络连接。有每个进程的最大连接数，选取哪种事件驱动模型处理连接请求，是否允许同时接受多个网路连接，开启多个网络连接序列化等。</li>
<li><strong>http块</strong>：可以嵌套多个server，配置代理，缓存，日志定义等绝大多数功能和第三方模块的配置。如文件引入，mime-type定义，日志自定义，是否使用sendfile传输文件，连接超时时间，单连接请求数等。</li>
<li><strong>server块</strong>：配置虚拟主机的相关参数，一个http中可以有多个server。</li>
<li><strong>location块</strong>：配置请求的路由，以及各种页面的处理情况。</li>
</ul>
<p><strong>配置项语法</strong></p>
<p>最基本的配置项语法格式如下</p>
<p>配置项名 配置项值1 配置项值2 … ;</p>
<p>首先，在行首的是配置项名，这些配置项名必须是Nginx的某一个模块想要处理的，否则Nginx会认为配置文件出现了非法的配置项名。配置项名输入结束后，将以空格作为分隔符。还有每行配置的结尾需要加上分号。</p>
<p><strong>配置项单位</strong></p>
<p>大部分模块遵循一些通用的规定，如指定空间大小时不用每次都定义到字节、指定时间时不用精确到毫秒。</p>
<p>当指定空间大小时，可以使用的单位包括：K或者k千字节（KiloByte，KB）和M或者m兆字节（MegaByte，MB）。</p>
<p>当指定时间时，可以使用的单位包括：ms（毫秒），s（秒），m（分钟），h（小时），d（天），w（周，包含7天），M（月，包含30天），y（年，包含365天）。</p>
<p><strong>在配置中使用变量</strong></p>
<h3 id="Nginx服务配置"><a href="#Nginx服务配置" class="headerlink" title="Nginx服务配置"></a>Nginx服务配置</h3><p>Nginx在运行时，至少必须加载几个核心模块和一个事件类模块。这些模块运行时所支持的配置项称为基本配置——所有其他模块执行时都依赖的配置项。由于配置项较多，所以把它们按照用户使用时的预期功能分成了以下4类：</p>
<ul>
<li>用于调试、定位问题的配置项。</li>
<li>正常运行的必备配置项。</li>
<li>优化性能的配置项。</li>
<li>事件类配置项（有些事件类配置项归纳到优化性能类，这是因为它们虽然也属于events{}块，但作用是优化性能）。</li>
</ul>
<p>有这么一些配置项，即使没有显式地进行配置，它们也会有默认的值，如daemon，即使在nginx.conf中没有对它进行配置，也相当于打开了这个功能，这点需要注意。对于这样的配置项，作者会在下面相应的配置项描述上加入一行“默认：”来进行说明。</p>
<p><strong>用于调试进程和定位问题的配置项</strong></p>
<p>（1）是否以守护进程方式运行Nginx</p>
<p>daemon on|off;  默认on</p>
<p>守护进程（daemon）是脱离终端并且在后台运行的进程。它脱离终端是为了避免进程执行过程中的信息在任何终端上显示，这样一来，进程也不会被任何终端所产生的信息所打断。</p>
<p>（2）是否以master/worker方式工作</p>
<p>master_process on|off;默认on</p>
<p>如果用off关闭了master_process方式，就不会fork出worker子进程来处理请求，而是用master进程自身来处理请求。</p>
<p>（3）error日志的设置</p>
<p>error_log/path/file level;  默认error_log logs/error.log error;</p>
<p>/path/file参数可以是一个具体的文件，例如，默认情况下是logs/error.log文件，最好将它放到一个磁盘空间足够大的位置；/path/file也可以是/dev/null，这样就不会输出任何日志了，这也是关闭error日志的唯一手段；/path/file也可以是stderr，这样日志会输出到标准错误文件中。</p>
<p>level是日志的输出级别，取值范围是debug、info、notice、warn、error、crit、alert、emerg，从左至右级别依次增大。当设定为一个级别时，大于或等于该级别的日志都会被输出到/path/file文件中，小于该级别的日志则不会输出。</p>
<p>（4）是否处理几个特殊的调试点</p>
<p>debug_points[stop|abort]</p>
<p>这个配置项也是用来帮助用户跟踪调试Nginx的。它接受两个参数：stop和abort。Nginx在一些关键的错误逻辑中（Nginx 1.0.14版本中有8处）设置了调试点。如果设置了debug_points为stop，那么Nginx的代码执行到这些调试点时就会发出SIGSTOP信号以用于调试。如果debug_points设置为abort，则会产生一个coredump文件，可以使用gdb来查看Nginx当时的各种信息。通常不会使用这个配置项。</p>
<p>（5）仅对指定的客户端输出debug级别的日志</p>
<p>debug_connection[IP|CIDR]</p>
<p>这个配置项实际上属于事件类配置，因此，它必须放在events{…}中才有效。它的值可以是IP地址或CIDR地址。这样，仅仅来自以上IP地址的请求才会输出debug级别的日志，其他请求仍然沿用error_log中配置的日志级别。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">event&#123;</span><br><span class="line">	debug_connection 192.168.1.1;</span><br><span class="line">	debug_connection 192.168.1.0/24;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<hr>
<p><strong>CIDR：</strong>无类域间路由,无类域间路由（Classless Inter-Domain Routing，CIDR）可以将路由集中起来，在路由表中更灵活地定义地址。它不区分 A 类、B 类、C 类地址，而是使用 CIDR 前缀的值指定地址中作为网络 ID 的位数。</p>
<p>这个前缀可以位于地址空间的任何位置，让管理者能够以更灵活的方式定义子网，以简便的形式指定地址中网络 ID 部分和主机 ID 部分。</p>
<p>CIDR 标记使用一个斜线<code>/</code>分隔符，后面跟一个十进制数值表示地址中网络部分所占的位数。例如，205.123.196.183/25 中的 25 表示地址中 25 位用于网络 ID，相应的掩码为 255.255.255.128。</p>
<hr>
<p>（6）限制coredump核心转储文件的大小</p>
<p>worker_rlimit_core size;</p>
<p>在Linux系统中，当进程发生错误或收到信号而终止时，系统会将进程执行时的内存内容（核心映像）写入一个文件（core文件），以作为调试之用，这就是所谓的核心转储（core dumps）。当Nginx进程出现一些非法操作（如内存越界）导致进程直接被操作系统强制结束时，会生成核心转储core文件，可以从core文件获取当时的堆栈、寄存器等信息，从而帮助我们定位问题。但这种core文件中的许多信息不一定是用户需要的，如果不加以限制，那么可能一个core文件会达到几GB，这样随便coredumps几次就会把磁盘占满，引发严重问题。通过worker_rlimit_core配置可以限制core文件的大小，从而有效帮助用户定位问题。</p>
<p>（7）指定coredump文件生成目录</p>
<p>working_directory path;</p>
<p>worker进程的工作目录。这个配置项的唯一用途就是设置coredump文件所放置的目录，协助定位问题。因此，需确保worker进程有权限向working_directory指定的目录中写入文件。</p>
<p><strong>正常运行的配置项</strong></p>
<p>（1）定义环境变量</p>
<p>env VAR|VAR=VALUE</p>
<p>这个配置项可以让用户直接设置操作系统上的环境变量。</p>
<p>（2）嵌入其他配置文件</p>
<p>include  /path/file;</p>
<p>include配置项可以将其他配置文件嵌入到当前的nginx.conf文件中，它的参数既可以是绝对路径，也可以是相对路径（相对于Nginx的配置目录，即nginx.conf所在的目录）。参数的值可以是一个明确的文件名，也可以是含有通配符*的文件名，同时可以一次嵌入多个配置文件。</p>
<p>（3）pid文件的路径</p>
<p>pid path/file;  默认pid logs/nginx.pid;</p>
<p>保存master进程ID的pid文件存放路径。默认与configure执行时的参数“–pid-path”所指定的路径是相同的，也可以随时修改，但应确保Nginx有权在相应的目标中创建pid文件，该文件直接影响Nginx是否可以运行。</p>
<p>（4）Nginx worker进程运行的用户及用户组</p>
<p>user username[groupname];   默认user nobody nobody;</p>
<p>user用于设置master进程启动后，fork出的worker进程运行在哪个用户和用户组下。当按照“user username;”设置时，用户组名与用户名相同。若用户在configure命令执行时使用了参数–user=username和–group=groupname，此时nginx.conf将使用参数中指定的用户和用户组。</p>
<p>（5）指定Nginx worker进程可以打开的最大句柄描述符个数</p>
<p>worker_rlimit_nofile limit;</p>
<p>设置一个worker进程可以打开的最大文件句柄数。</p>
<p>（6）限制信号队列</p>
<p>worker_rlimit_sigpending limit;</p>
<p>设置每个用户发往Nginx的信号队列的大小。也就是说，当某个用户的信号队列满了，这个用户再发送的信号量会被丢掉。</p>
<p><strong>优化性能的配置项</strong></p>
<p>（1）Nginx worker进程个数</p>
<p>worker_processes number;   默认worker_processes 1;</p>
<p>在master/worker运行方式下，定义worker进程的个数。</p>
<p>worker进程的数量会直接影响性能。那么，用户配置多少个worker进程才好呢？这实际上与业务需求有关。</p>
<p>每个worker进程都是单线程的进程，它们会调用各个模块以实现多种多样的功能。如果这些模块确认不会出现阻塞式的调用，那么，有多少CPU内核就应该配置多少个进程；反之，如果有可能出现阻塞式调用，那么需要配置稍多一些的worker进程。</p>
<p>例如，如果业务方面会致使用户请求大量读取本地磁盘上的静态资源文件，而且服务器上的内存较小，以至于大部分的请求访问静态资源文件时都必须读取磁盘（磁头的寻址是缓慢的），而不是内存中的磁盘缓存，那么磁盘I/O调用可能会阻塞住worker进程少量时间，进而导致服务整体性能下降。多worker进程可以充分利用多核系统架构，但若worker进程的数量多于CPU内核数，那么会增大进程间切换带来的消耗（Linux是抢占式内核）。一般情况下，用户要配置与CPU内核数相等的worker进程，并且使用下面的worker_cpu_affinity配置来绑定CPU内核。</p>
<p>（2）绑定Nginx worker进程到指定的CPU内核</p>
<p>worker_cpu_affinity cpumask[cpumask…]</p>
<p>为什么要绑定worker进程到指定的CPU内核呢？假定每一个worker进程都是非常繁忙的，如果多个worker进程都在抢同一个CPU，那么这就会出现同步问题。反之，如果每一个worker进程都独享一个CPU，就在内核的调度策略上实现了完全的并发。</p>
<hr>
<p>注意：worker_cpu_affinity配置仅对Linux操作系统有效。Linux操作系统使用sched_setaffinity()系统调用实现这个功能。</p>
<p>（3）SSL硬件加速</p>
<p>ssl_engine device；</p>
<p>如果服务器上有SSL硬件加速设备，那么就可以进行配置以加快SSL协议的处理速度。用户可以使用OpenSSL提供的命令来查看是否有SSL硬件加速设备：</p>
<p>（4）系统调用gettimeofday的执行频率</p>
<p>timer_resolution t;</p>
<p>默认情况下，每次内核的事件调用（如epoll、select、poll、kqueue等）返回时，都会执行一次gettimeofday，实现用内核的时钟来更新Nginx中的缓存时钟。在早期的Linux内核中，gettimeofday的执行代价不小，因为中间有一次内核态到用户态的内存复制。当需要降低gettimeofday的调用频率时，可以使用timer_resolution配置。例如，“timer_resolution 100ms；”表示至少每100ms才调用一次gettimeofday。</p>
<p>但在目前的大多数内核中，如x86-64体系架构，gettimeofday只是一次vsyscall，仅仅对共享内存页中的数据做访问，并不是通常的系统调用，代价并不大，一般不必使用这个配置。而且，如果希望日志文件中每行打印的时间更准确，也可以使用它。</p>
<p>（5）Nginx worker进程优先级设置</p>
<p>worker_priority nice;  默认 worker_priority 0;</p>
<p>该配置项用于设置Nginx worker进程的nice优先级。</p>
<p>在Linux或其他类UNIX操作系统中，当许多进程都处于可执行状态时，将按照所有进程的优先级来决定本次内核选择哪一个进程执行。进程所分配的CPU时间片大小也与进程优先级相关，优先级越高，进程分配到的时间片也就越大（例如，在默认配置下，最小的时间片只有5ms，最大的时间片则有800ms）。这样，优先级高的进程会占有更多的系统资源。</p>
<p>优先级由静态优先级和内核根据进程执行情况所做的动态调整（目前只有±5的调整）共同决定。nice值是进程的静态优先级，它的取值范围是–20~+19，–20是最高优先级，+19是最低优先级。因此，如果用户希望Nginx占有更多的系统资源，那么可以把nice值配置得更小一些，但不建议比内核进程的nice值（通常为–5）还要小。</p>
<p><strong>事件类配置项</strong></p>
<p>（1）是否打开accept锁</p>
<p>accept_mutex[on|off]  默认accept_mutext on;</p>
<p>accept_mutex是Nginx的负载均衡锁，accept_mutex这把锁可以让多个worker进程轮流地、序列化地与新的客户端建立TCP连接。当某一个worker进程建立的连接数量达到worker_connections配置的最大连接数的7/8时，会大大地减小该worker进程试图建立新TCP连接的机会，以此实现所有worker进程之上处理的客户端请求数尽量接近。</p>
<p>accept锁默认是打开的，如果关闭它，那么建立TCP连接的耗时会更短，但worker进程之间的负载会非常不均衡，因此不建议关闭它。</p>
<p>（2）lock文件的路径</p>
<p>lock_file path/file;  默认lock_file logs/nginx.lock;</p>
<p>accept锁可能需要这个lock文件，如果accept锁关闭，lock_file配置完全不生效。如果打开了accept锁，并且由于编译程序、操作系统架构等因素导致Nginx不支持原子锁，这时才会用文件锁实现accept锁，这样lock_file指定的lock文件才会生效。</p>
<hr>
<p>注意：在基于i386、AMD64、Sparc64、PPC64体系架构的操作系统上，若使用GCC、Intel C++、SunPro C++编译器来编译Nginx，则可以肯定这时的Nginx是支持原子锁的，因为Nginx会利用CPU的特性并用汇编语言来实现它。这时的lock_file配置是没有意义的。</p>
<p>（3）使用accept锁后到真正建立连接之间的延迟时间</p>
<p>accept_mutex_delay Nms;   默认：accept_mutex_delay 500ms;</p>
<p>在使用accept锁后，同一时间只有一个worker进程能够取到accept锁。这个accept锁不是阻塞锁，如果取不到会立刻返回。如果有一个worker进程试图取accept锁而没有取到，它至少要等accept_mutex_delay定义的时间间隔后才能再次试图取锁。</p>
<p>（4）批量建立新连接</p>
<p>multi_accept[on|off];  默认：multi_accept off;</p>
<p>当事件模型通知有新连接时，尽可能地对本次调度中客户端发起的所有TCP请求都建立连接。</p>
<p>（5）选择事件模型</p>
<p>use[kqueue|rtsig|epoll|/dev/poll|select|poll|eventport];   默认;Nginx会自动使用最适合的事件模型。</p>
<p>对于Linux操作系统来说，可供选择的事件驱动模型有poll、select、epoll三种。epoll当然是性能最高的一种.</p>
<p>（6）每个worker的最大连接数</p>
<p>worker_connections number;</p>
<p>定义每个worker进程可以同时处理的最大连接数。</p>
<h3 id="配置静态Web服务器"><a href="#配置静态Web服务器" class="headerlink" title="配置静态Web服务器"></a>配置静态Web服务器</h3><p>静态Web服务器的主要功能由ngx_http_core_module模块（HTTP框架的主要成员）实现。</p>
<p>所有的HTTP配置项都必须直属于http块、server块、location块、upstream块或if块等，同时，在描述每个配置项的功能时，会说明它可以在上述的哪个块中存在，因为有些配置项可以任意地出现在某一个块中，而有些配置项只能出现在特定的块中。Nginx为配置一个完整的静态Web服务器提供了非常多的功能，下面会把这些配置项分为以下8类进行详述：虚拟主机与请求的分发、文件路径的定义、内存及磁盘资源的分配、网络连接的设置、MIME类型的设置、对客户端请求的限制、文件操作的优化、对客户端请求的特殊处理。</p>
<p>简单的静态服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">#user  nobody;</span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line"></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen   80;</span><br><span class="line">        server_name  www.trackgan.com;</span><br><span class="line">		location / &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>





<h4 id="虚拟主机与请求的分发"><a href="#虚拟主机与请求的分发" class="headerlink" title="虚拟主机与请求的分发"></a>虚拟主机与请求的分发</h4><p><strong>（1）监听端口</strong></p>
<p>语法：listen  address:port[default(deprecated in 0.8.21)|default_server|[backlog=num|rcvbuf=size|sndbuf=size|accept_filter=filter|deferred|bind|ipv6only=[on|off]|ssl]];</p>
<p>默认：listen 80;</p>
<p>配置块：listen 80;</p>
<p>listen参数决定Nginx服务如何监听端口。在listen后可以只加IP地址、端口或主机名，非常灵活；</p>
<p>参数意义：</p>
<ul>
<li>default：将所在的server块作为整个Web服务的默认server块。如果没有设置这个参数，那么将会以在nginx.conf中找到的第一个server块作为默认server块。为什么需要默认虚拟主机呢？当一个请求无法匹配配置文件中的所有主机域名时，就会选用默认的虚拟主机</li>
<li>default_server：同上。</li>
<li>backlog=num：表示TCP中backlog队列的大小。默认为–1，表示不予设置。在TCP建立三次握手过程中，进程还没有开始处理监听句柄，这时backlog队列将会放置这些新连接。可如果backlog队列已满，还有新的客户端试图通过三次握手建立TCP连接，这时客户端将会建立连接失败。</li>
<li>rcvbuf=size：设置监听句柄的SO_RCVBUF参数。</li>
<li>sndbuf=size：设置监听句柄的SO_SNDBUF参数。</li>
<li>accept_filter：设置accept过滤器，只对FreeBSD操作系统有用。</li>
<li>deferred：在设置该参数后，若用户发起建立连接请求，并且完成了TCP的三次握手，内核也不会为了这次的连接调度worker进程来处理，只有用户真的发送请求数据时（内核已经在网卡中收到请求数据包），内核才会唤醒worker进程处理这个连接。这个参数适用于大并发的情况下，它减轻了worker进程的负担。当请求数据来临时，worker进程才会开始处理这个连接。只有确认上面所说的应用场景符合自己的业务需求时，才可以使用deferred配置。</li>
<li>bind：绑定当前端口/地址对，如127.0.0.1:8000。只有同时对一个端口监听多个地址时才会生效。</li>
<li>ssl：在当前监听的端口上建立的连接必须基于SSL协议。</li>
</ul>
<p><strong>（2）主机名称</strong> </p>
<p>语法：server_name name[…];</p>
<p>默认：server_name””;</p>
<p>配置块：server</p>
<p>server_name后可以跟多个主机名称，如server_name <a target="_blank" rel="noopener" href="http://www.testweb.com、download.testweb.com;./">www.testweb.com、download.testweb.com;。</a></p>
<p>在开始处理一个HTTP请求时，Nginx会取出header头中的Host，与每个server中的server_name进行匹配，以此决定到底由哪一个server块来处理这个请求。有可能一个Host与多个server块中的server_name都匹配，这时就会根据匹配优先级来选择实际处理的server块。server_name与Host的匹配优先级如下：</p>
<ul>
<li>首先选择所有字符串完全匹配的server_name，如：<a target="_blank" rel="noopener" href="http://www.trackgan.com/">www.trackgan.com</a></li>
<li>其次选择通配符在前面的server_name，如：*.trackgan.com</li>
<li>再次选择通配符在后面的server_name，如：<a target="_blank" rel="noopener" href="http://www.trackgan/">www.trackgan</a>.*</li>
<li>最后选择使用正则表达式才匹配的server_name，如~^.trackgan.com$。</li>
</ul>
<p>如果Host与所有的server_name都不匹配，这时将会按下列顺序选择处理的server块。</p>
<p>1）优先选择在listen配置项后加入[default|default_server]的server块。</p>
<p>2）找到匹配listen端口的第一个server块。</p>
<p>所以，在配置只能域名访问的时候，要加上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">server</span><br><span class="line">    &#123;</span><br><span class="line">        listen 80 default;</span><br><span class="line">        return 403;</span><br><span class="line">    &#125; </span><br></pre></td></tr></table></figure>

<p>如果server_name后跟着空字符串（如server_name””;），那么表示匹配没有Host这个HTTP头部的请求。</p>
<hr>
<p>注意：Nginx正是使用server_name配置项针对特定Host域名的请求提供不同的服务，以此实现虚拟主机功能。</p>
<p><strong>（3）server_names_hash_bucket_size</strong></p>
<p>语法：server_names_hash_bucket_size size;</p>
<p>默认：server_names_hash_bucket_size 32|64|128;</p>
<p>配置块：http、server、location</p>
<p>为了提高快速寻找到相应server name的能力，Nginx使用散列表来存储server name。server_names_hash_bucket_size设置了每个散列桶占用的内存大小。</p>
<p><strong>（4）server_names_hash_max_size</strong></p>
<p>语法：server_names_hash_max_size size;</p>
<p>默认：server_names_hash_max_size 512;</p>
<p>配置块：http、server、location</p>
<p>server_names_hash_max_size会影响散列表的冲突率。server_names_hash_max_size越大，消耗的内存就越多，但散列key的冲突率则会降低，检索速度也更快。server_names_hash_max_size越小，消耗的内存就越小，但散列key的冲突率可能增高。</p>
<p><strong>（5）重定向主机名称的处理</strong></p>
<p>语法：server_name_in_redirect on|off;</p>
<p>默认：server_name_in_redirect on;</p>
<p>配置块：http、server或者location</p>
<p>该配置需要配合server_name使用。在使用on打开时，表示在重定向请求时会使用server_name里配置的第一个主机名代替原先请求中的Host头部，而使用off关闭时，表示在重定向请求时使用请求本身的Host头部。</p>
<p><strong>（6）location</strong></p>
<p>语法：location[=|<del>|</del>*|^~|@]/uri/{…}</p>
<p>配置块：server</p>
<p>location会尝试根据用户请求中的URI来匹配上面的/uri表达式，如果可以匹配，就选择location{}块中的配置来处理用户请求。当然，匹配方式是多样的，下面介绍location的匹配规则。</p>
<ul>
<li>=表示把URI作为字符串，以便与参数中的uri做完全匹配。</li>
<li>~表示匹配URI时是字母大小写敏感的。</li>
<li>~*表示匹配URI时忽略字母大小写问题。</li>
<li>^~表示匹配URI时只需要其前半部分与uri参数匹配即可。</li>
<li>@表示仅用于Nginx服务内部请求之间的重定向，带有@的location不直接处理用户请求。</li>
</ul>
<hr>
<p>注意，location是有顺序的，当一个请求有可能匹配多个location时，实际上这个请求会被第一个location处理。</p>
<h4 id="文件路径的定义"><a href="#文件路径的定义" class="headerlink" title="文件路径的定义"></a>文件路径的定义</h4><p><strong>（1）以root方式设置资源路径</strong></p>
<p>语法：root path;</p>
<p>默认：root html;</p>
<p>配置块：http、server、location、if</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">location / &#123;</span><br><span class="line">            root   html;  <span class="comment"># html目录下的文件</span></span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>











<h2 id="面试题"><a href="#面试题" class="headerlink" title="面试题"></a>面试题</h2><p>才会有了异步非阻塞的事件处理机制，具体到系统调用就是像 select/poll/epoll/kqueue 这样的系统调用。它们提供了一种机制，让你可以同时监控多个事件，调用他们是阻塞的，但可以设置超时时间，在超时时间之内，如果有事件准备好了，</p>
<h2 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h2><h3 id="Linux安装ssl-certificate"><a href="#Linux安装ssl-certificate" class="headerlink" title="Linux安装ssl certificate"></a>Linux安装ssl certificate</h3>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://127.0.0.1:4000/2021/10/12/Nginx/" data-id="ckunowe970001qoq5eu5w2hbf" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2021/10/11/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/10/">October 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/10/12/Nginx/">Nginx</a>
          </li>
        
          <li>
            <a href="/2021/10/11/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2021 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>